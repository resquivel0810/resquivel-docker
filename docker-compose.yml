version: '3.8'

services:
  # nginx-proxy usará el puerto 80 que liberamos
  nginx-proxy:
    image: jwilder/nginx-proxy
    container_name: nginx-proxy
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/tmp/docker.sock:ro
      - ./certs:/etc/nginx/certs        # ← RUTA RELATIVA
      - ./vhost:/etc/nginx/vhost.d      # ← RUTA RELATIVA  
      - ./html:/usr/share/nginx/html    # ← RUTA RELATIVA
    restart: unless-stopped

  letsencrypt:
    image: jrcs/letsencrypt-nginx-proxy-companion
    container_name: letsencrypt
    depends_on:
      - nginx-proxy
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./certs:/etc/nginx/certs        # ← MISMAS RUTAS
      - ./vhost:/etc/nginx/vhost.d
      - ./html:/usr/share/nginx/html
    environment:
      - NGINX_PROXY_CONTAINER=nginx-proxy
    restart: unless-stopped

  wordpress:
    image: wordpress:latest
    container_name: wordpress
    # ¡NO EXPONES PUERTOS! El proxy manejará el tráfico
    # ports:
    #   - "8080:80"  # ← ELIMINA ESTA LÍNEA
    volumes:
      - ./site/wp-content:/var/www/html/wp-content
      - ./init/prep.sh:/prep.sh
    environment:
      WORDPRESS_DB_HOST: db
      WORDPRESS_DB_USER: resquive_wp870
      WORDPRESS_DB_PASSWORD: unamuysegura1
      WORDPRESS_DB_NAME: resquive_wp870
      WORDPRESS_TABLE_PREFIX: wpvf_
      # Variables para nginx-proxy
      VIRTUAL_HOST: resquivel.com,www.resquivel.com
      LETSENCRYPT_HOST: resquivel.com,www.resquivel.com
      LETSENCRYPT_EMAIL: resquivel0810@gmail.com
    restart: unless-stopped
    depends_on:
      - db

  db:
    image: mysql:5.7
    container_name: db
    environment:
      MYSQL_ROOT_PASSWORD: unamuysegura1
      MYSQL_DATABASE: resquive_wp870
      MYSQL_USER: resquive_wp870
      MYSQL_PASSWORD: unamuysegura1
    volumes:
      - ./database:/var/lib/mysql
    restart: unless-stopped

  adminer:
    image: adminer
    container_name: adminer
    ports:
      - "8082:8080"  # Mantenemos Adminer en 8082
    restart: unless-stopped